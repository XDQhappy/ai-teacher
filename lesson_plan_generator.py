# lesson_plan_generator.py
from openai import OpenAI
import streamlit as st

# 从 Streamlit secrets 获取 DeepSeek API Key
api_key = st.secrets.get("DEEPSEEK_API_KEY", "").strip()

# 正确写法：base_url 必须加 /v1
deepseek_client = OpenAI(
    api_key=api_key,
    base_url="https://api.deepseek.com/v1"
)

def generate_lesson_plan_with_text_chunks(
    title, subject, grade, duration,
    key_vocab, text_chunks,
    teaching_goals="", teaching_focus="", teaching_difficulties=""
):
    user_prompt = f"""
课程名称: {title}
学科: {subject}
年级: {grade}
课时: {duration}

关键词汇: {key_vocab}

教学目标:
{teaching_goals}

教学重点:
{teaching_focus}

教学难点:
{teaching_difficulties}

请根据以上内容生成完整教学方案，注意：

## 1. 角色扮演
你将扮演一位具备20年一线教学经验的特级教师，同时也是一位精通认知心理学与课程设计的教学专家。你的核心任务不是简单地“生成内容”，而是“设计一节完整的、可执行的、高效率的、以学生为中心的精品课”。你必须抛弃所有空洞、模板化的语言，每一个字都要为实际教学服务。
## 2. 核心任务
根据我提供的【授课主题】，生成一份完整、详尽、且融合了以下所有高级教学设计原则的“手写感”电子教案。
## 3. 教案结构模板
请严格按照以下结构和顺序生成教案，不得增删或随意调换顺序：
•	一、 教学目标 (须包含“知识与技能”和“过程与方法”两个维度，语言精炼，可被课堂活动直接验证)
•	二、 教学重难点 (清晰地区分重点与难点)（只有在教室没有填写的时候才生成，否则按老师填写的来完成）
•	三、 易错点提示 (此部分至关重要，详见下方“黄金法则”)
•	四、 教学过程 (主体部分，必须包含清晰的环节划分和时间标记)
o	(一) 情景引学
o	--- 约X分钟 ---
o	(二) 探究真学
o	--- 约X分钟 ---
o	(三) 明理深学
o	--- 约X分钟 ---
o	(四) 例题促学
o	--- 约X分钟 ---
o	(五) 小结思考
o	...
•	五、 课堂小结 (必须包含引导学生从不同维度进行总结的提问)
•	六、 布置作业 (必须体现分层设计，详见下方“黄金法则”)
•	七、 板书设计 (必须以结构化方式呈现，详见下方“黄金法则”)
## 4. 黄金法则与独特功能
这是让教案从“合格”跃升至“卓越”的秘诀，你必须将以下所有要素无缝融入到上述结构中：
1.	【“易错点提示”的撰写心法】
o	在三、 易错点提示部分，请深入预判并写出学生在本课中最可能犯的具体错误。如果确实存在普遍易错点，请务必指出；如果本节课内容较为基础，不易出错，也可不写。
o	描述必须精准到学生的思维误区，例如：“误将分母含x的方程当成整式方程”，而不是模糊的“概念不清”。
o	此部分将直接关联七、 板书设计中的“错误预警栏”。
2.	【“教学流程”的时间颗粒度】
o	在四、 教学过程的每个环节之间，必须插入一个格式为 --- 约X分钟 --- 的时间分割线，用于模拟教师对课堂节奏的精准把控。
3.	【“教师动作”指令嵌入】
o	在四、 教学过程的关键教学话术后，适时插入格式为 [动作：...] 的教师身体语言或手势指令。
o	动作需简短、形象、易于执行，旨在通过“手脑同步”加深学生肌肉记忆。例如：[动作：右手食指高高举起，强调“1”。]
4.	【“语言风格”的学生视角转换】
o	你的所有“教师话术”都必须使用初中生能一听就懂的、生动具体的动词和比喻。
o	严格遵守以下“词汇降级”原则：
	“抽象/概括” → “圈出相同的地方 / 找共同点”
	“数学建模” → “把话变成式子 / 看图列算式”
	“分类讨论” → “想一想，有几种不同的情况？”
5.	【“作业布置”的差异化设计】
o	在六、 布置作业部分，必须设置至少两个层次的作业：基础巩固题和拓展探究题。
o	必须使用特殊符号进行区分：基础题用“※”标记，拓展题用“☆”标记。
o	作业描述应为任务型，而非具体的页码，例如：“请你联系生活实际，自己编一道...”，以保证通用性。
6.	【“板书设计”的终局思维】
o	七、 板书设计必须以结构化的表格形式呈现，模拟一个分区清晰的黑板布局（如：左侧、中间、右侧）。
o	必须包含以下四个固定元素：
	【辅助简笔画】: 用一句话描述一个能帮助学生理解核心概念的简单图形。例如：“一个平衡的天平”。
	清晰的标题和分区。
	【红笔标注区】: 在关键定义或易错点处，明确指出应用红笔进行强调。
	【黑板快照】: 在表格结束后，用一句话文字描述这块黑板在课程结束时的最终样貌，帮助使用者快速建立版面全局观。
## 5. 必须避免的陷阱
•	禁止出现 “情感态度与价值观”这一模块，除非我特别要求。
•	禁止在作业中 出现具体的、不通用的教材页码或题号。
•	禁止使用 过于活泼、不正式的环节标题（如“游戏大闯关”），应使用“创设情境，引入新课”这类专业教学术语。
•	禁止生成 任何形式的、需要教师课后手写的留白区域（如“即时反思空位”），所有内容都应由你直接生成。
## 6. 执行指令
现在，请严格遵守以上所有角色设定、结构模板、黄金法则和避错陷阱，为我生成一节关于 【在此处填入你想要的授课主题，例如：有理数的乘方】 的特级教师教案，请直接开始教案的内容，不要回复我“好的”、“是的”、“接下来是为你生成的教案”这样的无关信息。

请结合我上传的教辅材料文本。
"""

    # messages 中加入所有文本块
    user_content = [{"type": "text", "text": user_prompt}]
    for chunk in text_chunks:
        user_content.append({"type": "text", "text": chunk})

    messages = [
        {"role": "system", "content": "你是一名专业中文AI教师助手。"},
        {"role": "user", "content": user_content}
    ]

    resp = deepseek_client.chat.completions.create(
        model="deepseek-chat",
        messages=messages
    )

    return resp.choices[0].message.content





